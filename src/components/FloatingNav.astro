---
const navLinks = [
  { href: "#details", label: "Details", short: "Details" },
  { href: "#venue", label: "Venue", short: "Venue" },
  { href: "#rsvp", label: "RSVP", short: "RSVP" },
  { href: "#our-story", label: "Story", short: "Story" },
  { href: "#bridal-party", label: "Party", short: "Party" },
  { href: "#gallery", label: "Gallery", short: "Gallery" },
  { href: "#registry", label: "Registry", short: "Registry" },
  { href: "#faq", label: "FAQ", short: "FAQ" },
];
---

<!-- Floating Pill Navigation -->
<nav
  id="floating-nav"
  class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 opacity-0 translate-y-4 transition-all duration-300"
  aria-label="Section navigation"
>
  <!-- Desktop: Full pill with labels -->
  <div
    class="hidden md:flex items-center gap-1 bg-white/95 backdrop-blur-md shadow-lg rounded-full px-2 py-2 border border-[var(--color-sage-light)]/30"
  >
    {
      navLinks.map((link) => (
        <a
          href={link.href}
          class="nav-pill-link px-3 py-1.5 text-xs uppercase tracking-wider text-[var(--color-gray)] hover:text-[var(--color-sage-dark)] hover:bg-[var(--color-sage-light)]/20 rounded-full transition-all duration-200"
          data-section={link.href.slice(1)}
        >
          {link.short}
        </a>
      ))
    }
  </div>

  <!-- mobile sheet moved outside to avoid transform stacking context issues -->
</nav>

<!-- Mobile sheet placed outside of the nav to avoid transform stacking context issues -->
  <div class="md:hidden">
  <!-- Peek (always visible) -->
  <div
    id="sheet-peek"
    class="sheet-peek fixed bottom-4 inset-x-4 z-60 flex items-center justify-between gap-3 px-4 py-3 bg-white/95 backdrop-blur-md shadow-lg rounded-full border border-[var(--color-sage-light)]/30 mx-auto max-w-[640px] pointer-events-auto cursor-pointer hover:shadow-xl transition-shadow"
  >
    <div class="flex items-center gap-2">
      <div id="sheet-progress-pill" class="text-xs font-medium bg-[var(--color-sage-light)]/20 px-2 py-1 rounded-full">1 / {navLinks.length}</div>
      <div id="current-section-label" class="text-xs uppercase tracking-wider font-medium">Details</div>
    </div>
    <button id="expand-nav-btn" class="sheet-handle flex items-center gap-2 text-[var(--color-charcoal)]" aria-label="Open site navigation" aria-expanded="false">
      <svg class="w-4 h-4 transition-transform duration-200" id="expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>
  </div>

  <!-- Expanded Bottom Sheet -->
  <div id="mobile-expanded-nav" class="sheet-expanded hidden fixed inset-x-4 bottom-4 z-60 rounded-2xl bg-white/98 backdrop-blur-md shadow-2xl border border-[var(--color-sage-light)]/30 max-h-[80vh] overflow-auto pointer-events-auto">
      <div class="p-2 border-b border-[var(--color-sage-light)]/20 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="close-sheet-btn" aria-label="Close navigation" class="p-2 rounded-md">✕</button>
          <div>
            <div class="text-sm font-semibold">Site Sections</div>
            <div class="text-xs text-[var(--color-gray)]">Browse the site</div>
          </div>
        </div>
        <!-- numeric progress pill retained -->
        <div id="sheet-progress-pill" class="text-xs font-medium bg-[var(--color-sage-light)]/20 px-2 py-1 rounded-full">1 / {navLinks.length}</div>
      </div>

    <div class="p-3">
      <div class="flex flex-col gap-2">
        {
          navLinks.map((link, i) => (
            <a href={link.href} class="sheet-list-item flex items-center justify-between gap-3 px-3 py-3 rounded-lg hover:bg-[var(--color-sage-light)]/10 transition-colors" data-section={link.href.slice(1)}>
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center rounded-full bg-[var(--color-sage-light)]/20 text-sm font-medium">{i + 1}</div>
                <div class="text-sm">{link.label}</div>
              </div>
              <div class="text-[var(--color-gray)]">›</div>
            </a>
          ))
        }
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const floatingNav = document.getElementById("floating-nav");
    const sheetPeek = document.getElementById("sheet-peek");
    const expandBtn = document.getElementById("expand-nav-btn");
    const expandedNav = document.getElementById("mobile-expanded-nav");
    const expandIcon = document.getElementById("expand-icon");
    const currentSectionLabel = document.getElementById("current-section-label");
    const navPillLinks = document.querySelectorAll(".nav-pill-link");
    const sheetListItems = document.querySelectorAll(".sheet-list-item");
    const closeSheetBtn = document.getElementById("close-sheet-btn");
    const sheetProgressPill = document.getElementById("sheet-progress-pill");

    // Section IDs to observe (parking maps to venue for highlighting)
    const sectionIds = [
      "details",
      "venue",
      "parking",
      "rsvp",
      "our-story",
      "bridal-party",
      "gallery",
      "registry",
      "faq",
      "contact",
    ];

    const sectionToNav = {
      "our-story": "our-story",
      details: "details",
      venue: "venue",
      parking: "venue",
      rsvp: "rsvp",
      "bridal-party": "bridal-party",
      gallery: "gallery",
      registry: "registry",
      faq: "faq",
      contact: "contact",
    };

    const sectionLabels = {
      details: "Details",
      venue: "Venue",
      rsvp: "RSVP",
      "our-story": "Story",
      "bridal-party": "Party",
      gallery: "Gallery",
      registry: "Registry",
      faq: "FAQ",
      contact: "Contact",
    };

    const heroHeight = document.getElementById("hero")?.offsetHeight || 500;

    function updateNavVisibility() {
      const scrollY = window.scrollY;
      if (scrollY > heroHeight * 0.5) {
        floatingNav?.classList.remove("opacity-0", "translate-y-4");
        floatingNav?.classList.add("opacity-100", "translate-y-0");
      } else {
        floatingNav?.classList.add("opacity-0", "translate-y-4");
        floatingNav?.classList.remove("opacity-100", "translate-y-0");
      }
    }

    function updateActiveSection() {
      const scrollY = window.scrollY + window.innerHeight / 3;
      let currentSection = sectionIds[0];

      for (const id of sectionIds) {
        const section = document.getElementById(id);
        if (section && section.offsetTop <= scrollY) {
          currentSection = id;
        }
      }

      const navSection = sectionToNav[currentSection] || currentSection;

      navPillLinks.forEach((link) => {
        const linkSection = link.getAttribute("data-section");
        if (linkSection === navSection) {
          link.classList.add(
            "bg-[var(--color-sage-light)]/30",
            "text-[var(--color-sage-dark)]"
          );
        } else {
          link.classList.remove(
            "bg-[var(--color-sage-light)]/30",
            "text-[var(--color-sage-dark)]"
          );
        }
      });

      // Update sheet list visual state
      sheetListItems.forEach((link) => {
        const linkSection = link.getAttribute("data-section");
        if (linkSection === navSection) {
          link.classList.add("bg-[var(--color-sage-light)]/30", "text-[var(--color-sage-dark)]", "font-medium");
        } else {
          link.classList.remove("bg-[var(--color-sage-light)]/30", "text-[var(--color-sage-dark)]", "font-medium");
        }
      });

      if (currentSectionLabel && sectionLabels[navSection]) {
        currentSectionLabel.textContent = sectionLabels[navSection];
      }

      // Update numeric progress pill (approximate index)
      const allNavKeys = Object.keys(sectionLabels);
      const index = Math.max(0, allNavKeys.indexOf(navSection));
      const total = allNavKeys.length || navLinks.length;
      if (sheetProgressPill) sheetProgressPill.textContent = `${index + 1} / ${total}`;
    }

    function openSheet() {
      expandedNav?.classList.remove("hidden");
      expandIcon?.classList.add("rotate-180");
      expandBtn?.setAttribute("aria-expanded", "true");
      // trap focus minimally
      expandedNav?.querySelector("a, button")?.focus();
    }

    function closeSheet() {
      expandedNav?.classList.add("hidden");
      expandIcon?.classList.remove("rotate-180");
      expandBtn?.setAttribute("aria-expanded", "false");
      expandBtn?.focus();
    }

    function toggleMobileNav() {
      if (expandedNav?.classList.contains("hidden")) openSheet(); else closeSheet();
    }

    // Make entire peek bar clickable
    sheetPeek?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleMobileNav();
    });

    // Mobile expand button (redundant but kept for accessibility)
    expandBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleMobileNav();
    });

    // Close button inside sheet
    closeSheetBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeSheet();
    });

    // Sheet list links - close sheet on selection
    sheetListItems.forEach((link) => {
      link.addEventListener("click", () => {
        closeSheet();
      });
    });

    // Close sheet when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest("#mobile-expanded-nav") && !e.target.closest("#sheet-peek")) {
        closeSheet();
      }
    });

    // Scroll handler
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateNavVisibility();
          updateActiveSection();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Initial state
    updateNavVisibility();
    updateActiveSection();
  });
</script>
